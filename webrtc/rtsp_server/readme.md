播放端
```shell
ffplay -rtsp_transport tcp rtsp://10.0.4.17:7777/main

```

服务器
```shell
 ./rtsp_tcp_server    
 
# proxy的FILENAME设置为h264的插播文件
# h264nal2rtp_send的ish265设置成false
 ./proxy    
```

命令端
```shell
kill -30 pid 
kill -31 pid 

```

## TVT私有协议分析

## audio/video 封装
- 固定长度21*4个字节
- 对于所有音频帧，视频的P帧
- Payload:表示从 Header之后 到下一个 0x31313131之前的字节的。
``` sh
    0      7 8     15 16    23 24    31
     +--------+--------+--------+--------+
 0   | 0x31   | 0x31   | 0x31   | 0x31   |
     +--------+--------+--------+--------+
 1   |           PayloadSize+76          |
     +--------+--------+--------+--------+
 2   | 0x01   | 0x00   | 0x00   | 0x0a   |
     +--------+--------+--------+--------+
 3   | 0xff   | 0xff   | 0xff   | 0xff   |
     +--------+--------+--------+--------+
 4   | 0x04   | 0x00   | 0x00   | 0x00   |
     +--------+--------+--------+--------+
 5   |           PayloadSize+60          |
     +--------+--------+--------+--------+
 6   |    音频=1，视频的idr=1,非idr=0      |
     +--------+--------+--------+--------+
 7   | type   | 0x00   | 0x00   | 0x00   | #video==0x01,audio=0x02
     +--------+--------+--------+--------+
 8   |       PayloadSize-offset          | #offset是0,1,2,3,PayloadSize-offset是实际的媒体数据大小,offset取值规律？？
     +--------+--------+--------+--------+
 9   |          video width              | #小端序，eg:80 07 00 00
     +--------+--------+--------+--------+   
 0   |          video height             | #小端序，eg: 38 04 00 00 
     +--------+--------+--------+--------+   
 1   |    ?   |    ?   |    ?   |    ?   | #对于视频 这个数是 48  X X,X, 经过验证被替换不影响结果
     +--------+--------+--------+--------+
 2   | ChId   | 0x00   | 0x00   | 0x00   | # channel有关
     +--------+--------+--------+--------+
 3   |    ?   |    ?   |    ?   |    ?   | 
     +--------+--------+--------+--------+
 4   | 0x00   | 0x00   | 0x00   | 0x00   |
     +--------+--------+--------+--------+
 5   | attr   | 0x00   | 0x00   | 0x00   | # 与frame attr有关,一般取值0x20,0x40?
     +--------+--------+--------+--------+
 6   | 0x00   | 0x00   | 0x00   | 0x00   |
     +--------+--------+--------+--------+
 7   |      Absolute  TimeStamp LSB      |
     +--------+--------+--------+--------+
 8   |      Absolute  TimeStamp MSB      |
     +--------+--------+--------+--------+
 9   |      Relative  TimeStamp LSB      | #与播放器时钟同步有关
     +--------+--------+--------+--------+
 0   |      Relative  TimeStamp MSB      |
     +--------+--------+--------+--------+
``` 
## video I帧封装
- 采用分包的形式，一般分2或4个包
- 第一个包Header长度是28x4个字节，其余的是9x4个字节。
- 最后一个包的数据规则与之前的有点差异，只要是验证一个包的结束。
- 除最后一个数据包意外，其他数据包都是131108个字节
- Payload: 具有相同KFId的 "payload" 的字节的聚合。

<font color=red>第一个PACK封装格式</font>
``` sh
    0      7 8     15 16    23 24    31
     +--------+--------+--------+--------+
 0   | 0x31   | 0x31   | 0x31   | 0x31   |
     +--------+--------+--------+--------+
 1   | 0x1c   | 0x00   | 0x02   | 0x00   | #注意：0x02001c-020x0000=28，0x0000来自words[7]的头三个字节
     +--------+--------+--------+--------+
 2   | 'P '   | 'A '   | 'C '   | 'K '   |
     +--------+--------+--------+--------+
 3   | KFId   | 0x00   | 0x00   | 0x00   | #关键帧的序号,递增,索引从1起始
     +--------+--------+--------+--------+
 4   | pSIZ   | 0x00   | 0x00   | 0x00   | #PACK 数量,一般是04或02
     +--------+--------+--------+--------+
 5   |           PayloadSize+76          |
     +--------+--------+--------+--------+
 6   | pIdx   | 0x00   | 0x00   | 0x00   | #PACK ID,递增,索引从1起始
     +--------+--------+--------+--------+
 7   | 0x00   | 0x00   | 0x02   | 0x00   | 
     +--------+--------+--------+--------+
 8   | 0x00   | 0x00   | 0x00   | 0x00   |  #这以下和普通的包都相同
     +--------+--------+--------+--------+
 9   | 0x01   | 0x00   | 0x00   | 0x0a   |
     +--------+--------+--------+--------+
 0   | 0xff   | 0xff   | 0xff   | 0xff   |
     +--------+--------+--------+--------+
 1   | 0x04   | 0x00   | 0x00   | 0x00   |
     +--------+--------+--------+--------+
 2   |           PayloadSize+60          |
     +--------+--------+--------+--------+
 3   |    音频=1，视频的idr=1,非idr=0      |
     +--------+--------+--------+--------+
 4   | type   | 0x00   | 0x00   | 0x00   | #video==0x01,audio=0x02
     +--------+--------+--------+--------+
 5   |       PayloadSize-offset          | #offset是0,1,2,3,PayloadSize-offset是实际的媒体数据大小,offset取值规律？？
     +--------+--------+--------+--------+
 6   |          video width              | #小端序，eg:80 07 00 00
     +--------+--------+--------+--------+   
 7   |          video height             | #小端序，eg: 38 04 00 00 
     +--------+--------+--------+--------+   
 8   |    ?   |    ?   |    ?   |    ?   | #对于视频 这个数是 48  X X,X, 经过验证被替换不影响结果
     +--------+--------+--------+--------+
 9   | ChId   | 0x00   | 0x00   | 0x00   | # channel有关
     +--------+--------+--------+--------+
 0   |    ?   |    ?   |    ?   |    ?   | 
     +--------+--------+--------+--------+
 1   | 0x00   | 0x00   | 0x00   | 0x00   |
     +--------+--------+--------+--------+
 2   | attr   | 0x00   | 0x00   | 0x00   | # 与frame attr有关,一般取值0x20,0x40?
     +--------+--------+--------+--------+
 3   | 0x00   | 0x00   | 0x00   | 0x00   |
     +--------+--------+--------+--------+
 4   |      Absolute  TimeStamp LSB      |
     +--------+--------+--------+--------+
 5   |      Absolute  TimeStamp MSB      |
     +--------+--------+--------+--------+
 6   |      Relative  TimeStamp LSB      | #与播放器时钟同步有关
     +--------+--------+--------+--------+
 7   |      Relative  TimeStamp MSB      |
     +--------+--------+--------+--------+
``` 

<font color=red>中间PACK封装格式</font>
``` sh
    0      7 8     15 16    23 24    31
     +--------+--------+--------+--------+
 0   | 0x31   | 0x31   | 0x31   | 0x31   |
     +--------+--------+--------+--------+
 1   | 0x1c   | 0x00   | 0x02   | 0x00   |  #注意：0x02001c-020x0000=28，0x0000来自words[7]的头三个字节
     +--------+--------+--------+--------+
 2   | 'P '   | 'A '   | 'C '   | 'K '   |
     +--------+--------+--------+--------+
 3   | KFId   | 0x00   | 0x00   | 0x00   | #关键帧的序号,递增,索引从1起始
     +--------+--------+--------+--------+
 4   | pSIZ   | 0x00   | 0x00   | 0x00   | #分包数量,一般是04或02
     +--------+--------+--------+--------+
 5   |           PayloadSize+76          |
     +--------+--------+--------+--------+
 6   | pIdx   | 0x00   | 0x00   | 0x00   | #分包ID,递增,索引从1起始
     +--------+--------+--------+--------+
 7   | 0x00   | 0x00   | 0x02   | 0x00   | #与words[1]有关
     +--------+--------+--------+--------+
 8   | 0x00   | 0x00   | 0x00   | 0x00   |  #这以下和普通的包都相同
     +--------+--------+--------+--------+
```



<font color=red>最后的PACK封装格式</font>
``` sh
    0      7 8     15 16    23 24    31
     +--------+--------+--------+--------+
 0   | 0x31   | 0x31   | 0x31   | 0x31   |
     +--------+--------+--------+--------+
 1   | XXXX   | XXXX   | ？     | 0x00   |  #这个字段的取值是 words[7]+28,小端序
     +--------+--------+--------+--------+
 2   | 'P '   | 'A '   | 'C '   | 'K '   |
     +--------+--------+--------+--------+
 3   | KFId   | 0x00   | 0x00   | 0x00   | #关键帧的序号,递增,索引从1起始
     +--------+--------+--------+--------+
 4   | pSIZ   | 0x00   | 0x00   | 0x00   | #分包数量,一般是04或02
     +--------+--------+--------+--------+
 5   |           PayloadSize+76          |
     +--------+--------+--------+--------+
 6   | pIdx   | 0x00   | 0x00   | 0x00   | #分包ID,递增,索引从1起始
     +--------+--------+--------+--------+
 7   | W[5][0]| W[5][1]| ？     | 0x00   | #与words[5]的头两个字节
     +--------+--------+--------+--------+
 8   | 0x00   | 0x00   | 0x00   | 0x00   |  #这以下和普通的包都相同
     +--------+--------+--------+--------+
```